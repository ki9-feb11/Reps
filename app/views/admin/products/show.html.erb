<div class="container mt-4">
  <!-- ヘッダー部分 -->
  <div class="row mb-4">
    <div class="col-12">
      <%= link_to admin_products_path, class: "btn btn-outline-secondary btn-sm mb-3" do %>
        <i class="fas fa-arrow-left me-1"></i>商品一覧に戻る
      <% end %>
    </div>
  </div>

  <div class="row">
    <!-- 商品基本情報 -->
    <div class="col-lg-5 mb-4">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-gradient-primary text-white">
          <h3 class="mb-0 text-white">
            <i class="fas fa-cube me-2"></i>
            <%= @product.name %>
          </h3>
        </div>
        <div class="card-body">
          <!-- 基本情報 -->
          <div class="product-info">
            <div class="row mb-3">
              <div class="col-sm-4">
                <div class="d-flex align-items-center mb-2">
                  <i class="fas fa-industry text-primary me-2"></i>
                  <span class="text-muted small fw-semibold">メーカー</span>
                </div>
              </div>
              <div class="col-sm-8">
                <p class="mb-0 fw-medium fs-5">
                  <%= @product.manufacturer.presence || "未設定" %>
                </p>
              </div>
            </div>

            <div class="row mb-4">
              <div class="col-sm-4">
                <div class="d-flex align-items-center mb-2">
                  <i class="fas fa-tags text-primary me-2"></i>
                  <span class="text-muted small fw-semibold">カテゴリー</span>
                </div>
              </div>
              <div class="col-sm-8">
                <span class="badge bg-info fs-6 px-3 py-2">
                  <%= @product.category.presence || "未分類" %>
                </span>
              </div>
            </div>
          </div>

          <!-- アクションボタン -->
          <div class="d-flex gap-2 mb-3">
            <%= link_to edit_admin_product_path(@product), class: "btn btn-primary flex-fill" do %>
              <i class="fas fa-edit me-1"></i>編集
            <% end %>
            <%= link_to admin_products_path, class: "btn btn-outline-secondary flex-fill" do %>
              <i class="fas fa-list me-1"></i>一覧
            <% end %>
          </div>
          
          <!-- 削除ボタン -->
          <div>
            <%= button_to admin_product_path(@product), method: :delete, 
                data: { confirm: "本当に削除しますか？" }, 
                class: "btn btn-danger w-100" do %>
              <i class="fas fa-trash me-1"></i>削除
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- 価格情報と統計 -->
    <div class="col-lg-7">
      <!-- 価格情報カード -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white border-bottom">
          <h4 class="mb-0">
            <i class="fas fa-yen-sign me-2 text-success"></i>価格情報
          </h4>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <div class="price-card bg-info text-white text-center p-4 rounded">
                <div class="price-icon mb-2">
                  <i class="fas fa-tag fa-2x"></i>
                </div>
                <small class="d-block text-white-50 mb-1">定価</small>
                <div class="fs-4 fw-bold">
                  <%= number_to_currency(@product.list_price, unit: "¥", format: "%u%n") %>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="price-card bg-warning text-white text-center p-4 rounded">
                <div class="price-icon mb-2">
                  <i class="fas fa-handshake fa-2x"></i>
                </div>
                <small class="d-block text-white-50 mb-1">卸単価</small>
                <div class="fs-4 fw-bold">
                  <%= number_to_currency(@product.wholesale_price, unit: "¥", format: "%u%n") %>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="price-card bg-danger text-white text-center p-4 rounded">
                <div class="price-icon mb-2">
                  <i class="fas fa-calculator fa-2x"></i>
                </div>
                <small class="d-block text-white-50 mb-1">原価</small>
                <div class="fs-4 fw-bold">
                  <%= number_to_currency(@product.cost_price, unit: "¥", format: "%u%n") %>
                </div>
              </div>
            </div>
          </div>

          <!-- 利益率計算 -->
          <div class="row mt-4">
            <div class="col-md-6">
              <div class="border rounded p-3 text-center">
                <small class="text-muted">卸利益率</small>
                <div class="fs-5 fw-bold text-success">
                  <% if @product.wholesale_price > 0 %>
                    <% wholesale_margin = ((@product.wholesale_price - @product.cost_price) / @product.wholesale_price * 100).round(1) %>
                    <%= wholesale_margin %>%
                  <% else %>
                    0%
                  <% end %>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="border rounded p-3 text-center">
                <small class="text-muted">定価利益率</small>
                <div class="fs-5 fw-bold text-success">
                  <% if @product.list_price > 0 %>
                    <% list_margin = ((@product.list_price - @product.cost_price) / @product.list_price * 100).round(1) %>
                    <%= list_margin %>%
                  <% else %>
                    0%
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 商談履歴・統計情報 -->
      <div class="card shadow-sm">
        <div class="card-header bg-white border-bottom">
          <h4 class="mb-0">
            <i class="fas fa-chart-bar me-2 text-primary"></i>商談統計
          </h4>
        </div>
        <div class="card-body">
          <% if @product.respond_to?(:post_products) %>
            <div class="row g-3 mb-4">
              <div class="col-md-3">
                <div class="stat-card bg-primary text-white text-center p-3 rounded">
                  <div class="fs-4 fw-bold">
                    <%= @product.post_products.count %>
                  </div>
                  <small>提案回数</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-card bg-success text-white text-center p-3 rounded">
                  <div class="fs-4 fw-bold">
                    <%= @product.post_products.joins(:post).where(posts: { result_status: 'success' }).count %>
                  </div>
                  <small>成功案件</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-card bg-info text-white text-center p-3 rounded">
                  <div class="fs-4 fw-bold">
                    <%= @product.post_products.sum(:quantity) %>
                  </div>
                  <small>総提案数</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-card bg-warning text-white text-center p-3 rounded">
                  <div class="fs-4 fw-bold">
                    <% if @product.post_products.count > 0 %>
                      <%= ((@product.post_products.joins(:post).where(posts: { result_status: 'success' }).count.to_f / @product.post_products.count) * 100).round(1) %>%
                    <% else %>
                      0%
                    <% end %>
                  </div>
                  <small>成功率</small>
                </div>
              </div>
            </div>

            <!-- 最近の商談履歴 -->
            <h5 class="mb-3">
              <i class="fas fa-clock me-2"></i>最近の提案履歴
            </h5>
            <% recent_proposals = @product.post_products.joins(:post).includes(:post).order(created_at: :desc).limit(5) %>
            <% if recent_proposals.any? %>
              <div class="proposal-history">
                <% recent_proposals.each do |pp| %>
                  <div class="d-flex justify-content-between align-items-center p-3 border rounded mb-2">
                    <div class="flex-grow-1">
                      <h6 class="mb-1">
                        <%= link_to pp.post.title, post_path(pp.post), 
                            class: "text-decoration-none text-primary" %>
                      </h6>
                      <small class="text-muted">
                        <i class="fas fa-building me-1"></i>
                        <%= pp.post.customer.name if pp.post.respond_to?(:customer) %>
                        <span class="mx-2">•</span>
                        <i class="fas fa-cube me-1"></i>
                        <%= pp.quantity %>個
                      </small>
                    </div>
                    <div class="text-end">
                      <% if pp.post.respond_to?(:result_status) %>
                        <span class="badge bg-<%= pp.post.result_status == 'success' ? 'success' : pp.post.result_status == 'pending' ? 'warning' : 'secondary' %> mb-1">
                          <%= pp.post.result_status_i18n if pp.post.respond_to?(:result_status_i18n) %>
                        </span>
                      <% end %>
                      <br>
                      <small class="text-muted">
                        <%= l(pp.created_at, format: :short) %>
                      </small>
                    </div>
                  </div>
                <% end %>
              </div>
            <% else %>
              <div class="text-center py-4">
                <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                <p class="text-muted mb-0">この商品の提案履歴はありません</p>
              </div>
            <% end %>
          <% else %>
            <div class="text-center py-4">
              <i class="fas fa-chart-bar fa-2x text-muted mb-2"></i>
              <p class="text-muted mb-0">統計情報は利用できません</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
